<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
    <!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta charset="UTF-8">
    <title>Students Page</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        .is-valid {
            border-color: #28a745 !important;
        }
        
        .is-invalid {
            border-color: #dc3545 !important;
        }
        
        .validation-alert {
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }
        
        .badge-enrolled {
            background-color: #17a2b8;
        }
        
        .badge-not-enrolled {
            background-color: #6c757d;
        }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">Class Roster</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item" th:if="${#authorization.expression('hasAnyRole(''ADMIN'', ''TEACHER'')')}">
                        <a class="nav-link" href="/teachers">Teachers</a>
                    </li>
                    <li class="nav-item" th:if="${#authorization.expression('hasAnyRole(''ADMIN'', ''TEACHER'', ''STUDENT'')')}">
                        <a class="nav-link" href="/students">Students</a>
                    </li>
                    <li class="nav-item" th:if="${#authorization.expression('hasAnyRole(''ADMIN'', ''TEACHER'')')}">
                        <a class="nav-link" href="/courses">Courses</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item" th:if="${#authorization.expression('isAuthenticated()')}">
                        <span class="navbar-text mr-3">
                            Welcome, <span th:text="${#authentication.name}">User</span>
                            <span th:text="${#authentication.authorities}" class="badge badge-light ml-2"></span>
                        </span>
                    </li>
                    <li class="nav-item" th:if="${#authorization.expression('isAuthenticated()')}">
                        <!-- <form th:action="@{/logout}" method="post" class="form-inline">
                            <button type="submit" class="btn btn-outline-light">Logout</button>
                        </form> -->
                        <!-- <a th:href="@{/logout}" class="btn btn-outline-light">Logout</a> -->
                        <a class="nav-link" href="/logout">Logout</a>
                    </li>
                    <!-- <li class="nav-item" th:unless="${#authorization.expression('isAuthenticated()')}">
                        <a class="nav-link" href="/login">Login</a>
                    </li> -->
                </ul>
            </div>
        </div>
    </nav>


<body>

<div class="container">
    <!-- Page Title -->
    <div class="row m-4">
        <div class="col text-center border border-dark bg-light">
            <h1 class="mb-0 py-3">
                <a href="/" class="text-dark text-decoration-none">
                    <i class="fas fa-user-graduate mr-2"></i>Student Management
                </a>
            </h1>
        </div>
    </div>
    
    <!-- Navigation Buttons -->
    <div class="row m-4 border border-dark bg-light">
        <div class="col text-center m-3">
            <a href="teachers" class="btn btn-outline-primary btn-lg" 
               th:if="${#authorization.expression('hasAnyRole(''ADMIN'', ''TEACHER'')')}">
                <i class="fas fa-chalkboard-teacher mr-2"></i>Teachers
            </a>
        </div>
        <div class="col text-center m-3">
            <a href="students" class="btn btn-primary btn-lg">
                <i class="fas fa-user-graduate mr-2"></i>Students
            </a>
        </div>
        <div class="col text-center m-3">
            <a href="courses" class="btn btn-outline-primary btn-lg"
               th:if="${#authorization.expression('hasAnyRole(''ADMIN'', ''TEACHER'')')}">
                <i class="fas fa-book mr-2"></i>Courses
            </a>
        </div>
    </div>
    
    <!-- Student View Notice -->
    <div th:if="${isStudentView != null and isStudentView}" class="row m-4">
        <div class="col">
            <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-info-circle fa-2x mr-3"></i>
                <div>
                    <h5 class="alert-heading mb-1">Student View</h5>
                    <p class="mb-0">You are viewing only your own student record. Students can only edit their own information.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Message Display -->
    <div th:if="${successMessage}" class="row m-4">
        <div class="col">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle mr-2"></i>
                <strong>Success!</strong> <span th:text="${successMessage}"></span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Error Message Display -->
    <div th:if="${errorMessage}" class="row m-4">
        <div class="col">
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <strong>Error:</strong> <span th:text="${errorMessage}"></span>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Students Table (only shown to ADMIN/TEACHER) -->
    <div th:if="${isStudentView != null and not isStudentView}" class="row m-4 border border-dark">
        <div class="col text-center m-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">
                    <i class="fas fa-users mr-2"></i>All Students
                </h4>
                <span class="badge badge-primary p-2">
                    Total: <span th:text="${students.size()}"></span> student(s)
                </span>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered">
                    <thead class="thead-dark">
                    <tr>
                        <th>ID</th>
                        <th>Student ID</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Courses Enrolled</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="student : ${students}" th:class="${studentStat.odd}? 'table-active'">
                        <td th:text="${student.id}">Student ID</td>
                        <td>
                            <span class="font-weight-bold text-primary" th:text="${student.studentId}"></span>
                        </td>
                        <td th:text="${student.firstName}">First Name</td>
                        <td th:text="${student.lastName}">Last Name</td>
                        <td>
                            <div th:if="${student.courses != null and not student.courses.isEmpty()}">
                                <div class="mb-1">
                                    <span class="badge badge-enrolled p-2 mr-1" th:text="${student.courses.size()}"></span>
                                    <span class="small text-muted">course(s)</span>
                                </div>
                                <div class="small">
                                    <span th:each="course, stat : ${student.courses}">
                                        <span class="badge badge-light border" th:text="${course.name}"></span>
                                        <span th:if="${!stat.last}"> </span>
                                    </span>
                                </div>
                            </div>
                            <div th:if="${student.courses == null or student.courses.isEmpty()}">
                                <span class="badge badge-not-enrolled p-2">Not enrolled</span>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a th:href="@{/editStudent(id=${student.id})}" 
                                   class="btn btn-warning btn-sm" 
                                   title="Edit student">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                <a th:href="@{/deleteStudent(id=${student.id})}" 
                                   class="btn btn-danger btn-sm"
                                   onclick="return confirmDeleteStudent(this)"
                                   title="Delete student">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Student View (for STUDENT role) -->
    <div th:if="${isStudentView != null and isStudentView}" class="row m-4 border border-dark">
        <div class="col text-center m-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-id-card mr-2"></i>My Student Profile
                    </h5>
                </div>
                <div class="card-body">
                    <div th:each="student : ${students}">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted mb-3">
                                            <i class="fas fa-info-circle mr-2"></i>Personal Information
                                        </h6>
                                        <p class="card-text">
                                            <strong>Student ID:</strong><br>
                                            <span class="badge badge-secondary p-2" th:text="${student.studentId}"></span>
                                        </p>
                                        <p class="card-text">
                                            <strong>Name:</strong><br>
                                            <span class="h5" th:text="${student.firstName + ' ' + student.lastName}"></span>
                                        </p>
                                        <a th:href="@{/editStudent(id=${student.id})}" class="btn btn-warning">
                                            <i class="fas fa-user-edit mr-1"></i> Edit My Profile
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title text-muted mb-3">
                                            <i class="fas fa-book mr-2"></i>Course Enrollment
                                        </h6>
                                        <p class="card-text">
                                            <strong>Enrolled Courses:</strong>
                                        </p>
                                        <div th:if="${student.courses != null and not student.courses.isEmpty()}">
                                            <div class="list-group">
                                                <div th:each="course : ${student.courses}" 
                                                     class="list-group-item list-group-item-action">
                                                    <div class="d-flex w-100 justify-content-between">
                                                        <h6 class="mb-1" th:text="${course.name}"></h6>
                                                        <small class="text-muted">ID: <span th:text="${course.id}"></span></small>
                                                    </div>
                                                    <p class="mb-1 small" th:text="${course.description}"></p>
                                                    <small class="text-muted" 
                                                           th:if="${course.teacher != null}">
                                                        <i class="fas fa-chalkboard-teacher mr-1"></i>
                                                        Teacher: <span th:text="${course.teacher.firstName + ' ' + course.teacher.lastName}"></span>
                                                    </small>
                                                    <small class="text-muted" 
                                                           th:if="${course.teacher == null}">
                                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                                        No teacher assigned
                                                    </small>
                                                </div>
                                            </div>
                                            <p class="mt-2 mb-0 small text-muted">
                                                <i class="fas fa-info-circle mr-1"></i>
                                                Contact your administrator to enroll in additional courses.
                                            </p>
                                        </div>
                                        <div th:if="${student.courses == null or student.courses.isEmpty()}" class="alert alert-warning">
                                            <i class="fas fa-book-reader mr-2"></i>
                                            You are not enrolled in any courses.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Student Form (only shown to ADMIN/TEACHER) -->
    <div th:if="${isStudentView != null and not isStudentView}" class="row m-4 border border-dark bg-light">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-plus mr-2"></i>Add New Student
                    </h5>
                </div>
                <div class="card-body">
                    <form action="addStudent" method="POST" id="addStudentForm" novalidate>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="studentId" class="font-weight-bold">
                                        <i class="fas fa-id-card mr-1"></i>Student ID *
                                    </label>
                                    <input type="text" 
                                           name="studentId" 
                                           id="studentId" 
                                           class="form-control" 
                                           required 
                                           placeholder="e.g., STU001 or 2024001"
                                           maxlength="20"
                                           pattern="[A-Za-z0-9]+"
                                           title="Student ID can only contain letters and numbers (no special characters or spaces)">
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        3-20 characters, letters and numbers only (no spaces or special characters)
                                    </small>
                                    <div class="valid-feedback">
                                        <i class="fas fa-check"></i> Valid student ID
                                    </div>
                                    <div class="invalid-feedback">
                                        Please provide a valid student ID (3-20 characters, letters/numbers only).
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="firstName" class="font-weight-bold">
                                        <i class="fas fa-user mr-1"></i>First Name *
                                    </label>
                                    <input type="text" 
                                           name="firstName" 
                                           id="firstName" 
                                           class="form-control" 
                                           required 
                                           placeholder="Enter first name"
                                           maxlength="50"
                                           pattern="^[A-Za-z\s.'-]+$"
                                           title="First name can only contain letters, spaces, apostrophes, periods, and hyphens">
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        2-50 characters, letters only (spaces, apostrophes, periods, hyphens allowed)
                                    </small>
                                    <div class="valid-feedback">
                                        <i class="fas fa-check"></i> Valid first name
                                    </div>
                                    <div class="invalid-feedback">
                                        Please provide a valid first name (2-50 characters, letters only).
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="lastName" class="font-weight-bold">
                                        <i class="fas fa-user mr-1"></i>Last Name *
                                    </label>
                                    <input type="text" 
                                           name="lastName" 
                                           id="lastName" 
                                           class="form-control" 
                                           required 
                                           placeholder="Enter last name"
                                           maxlength="50"
                                           pattern="^[A-Za-z\s.'-]+$"
                                           title="Last name can only contain letters, spaces, apostrophes, periods, and hyphens">
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        2-50 characters, letters only (spaces, apostrophes, periods, hyphens allowed)
                                    </small>
                                    <div class="valid-feedback">
                                        <i class="fas fa-check"></i> Valid last name
                                    </div>
                                    <div class="invalid-feedback">
                                        Please provide a valid last name (2-50 characters, letters only).
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="alert alert-info small">
                                    <i class="fas fa-lightbulb mr-2"></i>
                                    <strong>Note:</strong> All fields marked with * are required. Student ID must be unique.
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group mt-4">
                            <button type="submit" class="btn btn-success btn-lg mr-2">
                                <i class="fas fa-save mr-1"></i> Add Student
                            </button>
                            <button type="reset" class="btn btn-secondary btn-lg">
                                <i class="fas fa-undo mr-1"></i> Clear Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>

<!-- Custom Validation Script -->
<script>
    // Client-side validation for student forms
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-dismiss alerts after 5 seconds
        setTimeout(function() {
            $('.alert:not(.validation-alert)').alert('close');
        }, 5000);
        
        // Form validation
        const addStudentForm = document.getElementById('addStudentForm');
        if (addStudentForm) {
            addStudentForm.addEventListener('submit', function(event) {
                if (!validateStudentForm(this)) {
                    event.preventDefault();
                    event.stopPropagation();
                    return false;
                }
                this.classList.add('was-validated');
                return true;
            });
            
            // Real-time validation for inputs
            ['studentId', 'firstName', 'lastName'].forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (input) {
                    input.addEventListener('input', function() {
                        validateRealTime(this);
                    });
                    input.addEventListener('blur', function() {
                        validateRealTime(this);
                    });
                }
            });
        }
        
        // Initialize Bootstrap validation
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                // Fetch all the forms we want to apply custom Bootstrap validation styles to
                var forms = document.getElementsByClassName('needs-validation');
                // Loop over them and prevent submission
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();
    });
    
    // Delete confirmation with student details
    function confirmDeleteStudent(link) {
        const row = $(link).closest('tr');
        const studentId = row.find('td:nth-child(2)').text().trim();
        const firstName = row.find('td:nth-child(3)').text().trim();
        const lastName = row.find('td:nth-child(4)').text().trim();
        const courseCount = row.find('.badge-enrolled').text().trim() || '0';
        
        let message = `Are you sure you want to delete student:\n\n`;
        message += `ID: ${studentId}\n`;
        message += `Name: ${firstName} ${lastName}\n`;
        message += `Enrolled in ${courseCount} course(s)\n\n`;
        message += `This action cannot be undone!`;
        
        return confirm(message);
    }
    
    // Real-time validation
    function validateRealTime(input) {
        const value = input.value.trim();
        const fieldName = input.id === 'studentId' ? 'Student ID' : 
                         input.id === 'firstName' ? 'First name' : 'Last name';
        
        let isValid = false;
        let message = '';
        
        if (input.required && !value) {
            message = `${fieldName} is required.`;
        } else if (input.id === 'studentId') {
            if (value.length < 3 || value.length > 20) {
                message = 'Student ID must be between 3 and 20 characters.';
            } else if (!/^[A-Za-z0-9]+$/.test(value)) {
                message = 'Student ID can only contain letters and numbers.';
            } else if (/\s/.test(value)) {
                message = 'Student ID cannot contain spaces.';
            } else {
                isValid = true;
            }
        } else if (input.id === 'firstName' || input.id === 'lastName') {
            if (value.length < 2 || value.length > 50) {
                message = `${fieldName} must be between 2 and 50 characters.`;
            } else if (!/^[A-Za-z\s.'-]+$/.test(value)) {
                message = `${fieldName} can only contain letters, spaces, apostrophes, periods, and hyphens.`;
            } else if (/^\s|\s$/.test(value)) {
                message = `${fieldName} cannot have leading or trailing spaces.`;
            } else if (/\s\s+/.test(value)) {
                message = `${fieldName} cannot have consecutive spaces.`;
            } else {
                isValid = true;
            }
        }
        
        // Update visual feedback
        if (isValid) {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
            showHelpText(input, '', 'valid');
        } else {
            input.classList.remove('is-valid');
            input.classList.add('is-invalid');
            showHelpText(input, message, 'invalid');
        }
        
        return isValid;
    }
    
    // Show help text with appropriate styling
    function showHelpText(input, message, type) {
        // Remove existing feedback
        const existingFeedback = input.nextElementSibling;
        if (existingFeedback && (existingFeedback.classList.contains('valid-feedback') || 
                                 existingFeedback.classList.contains('invalid-feedback'))) {
            existingFeedback.remove();
        }
        
        if (message) {
            const feedback = document.createElement('div');
            feedback.className = type === 'valid' ? 'valid-feedback' : 'invalid-feedback';
            feedback.style.display = 'block';
            feedback.innerHTML = type === 'valid' ? 
                '<i class="fas fa-check"></i> Valid' : 
                '<i class="fas fa-exclamation-circle"></i> ' + message;
            input.parentNode.appendChild(feedback);
        }
    }
    
    // Full form validation
    function validateStudentForm(form) {
        let isValid = true;
        const errorMessages = [];
        
        // Validate each field
        ['studentId', 'firstName', 'lastName'].forEach(fieldId => {
            const input = form[fieldId];
            if (!validateRealTime(input)) {
                isValid = false;
            }
        });
        
        // Show error summary if needed
        if (!isValid) {
            showErrorSummary('Please fix the errors in the form before submitting.');
        }
        
        return isValid;
    }
    
    // Show error summary
    function showErrorSummary(message) {
        // Remove existing error summary
        $('.error-summary').remove();
        
        // Create error summary
        const errorDiv = $('<div class="alert alert-danger error-summary alert-dismissible fade show" role="alert">' +
            '<i class="fas fa-exclamation-triangle mr-2"></i>' +
            '<strong>Form Errors:</strong> ' + message +
            '<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
            '<span aria-hidden="true">&times;</span>' +
            '</button>' +
            '</div>');
        
        // Insert before form
        $('#addStudentForm').before(errorDiv);
        
        // Scroll to error summary
        $('html, body').animate({
            scrollTop: errorDiv.offset().top - 100
        }, 500);
    }
    
    // Initialize tooltips
    $(function () {
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>

</body>
</html>